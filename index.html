<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>Mesaje</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="login">
    <a href="/auth/google"><button>Login cu Google</button></a>
  </div>

  <div id="logout" style="display:none;">
    <button onclick="logout()">Logout</button>
  </div>

  <h2>Toate mesajele</h2>
  <div id="allMessages"></div>

  <div id="userSection" style="display:none;">
    <h2>Mesajele mele</h2>
    <div id="myMessages"></div>

    <h3>Adaugă mesaj</h3>
    <form id="newMessageForm">
      <input type="text" id="messageInput" placeholder="Scrie mesajul" required />
      <button type="submit">Trimite</button>
    </form>
  </div>

  <script>
    async function checkUser() {
      const res = await fetch("/auth/user");
      const data = await res.json();
      renderUI(data.user);
    }

    function renderUI(user) {
      if (!user) {
        document.getElementById("login").style.display = "block";
        document.getElementById("logout").style.display = "none";
        document.getElementById("userSection").style.display = "none";
      } else {
        document.getElementById("login").style.display = "none";
        document.getElementById("logout").style.display = "block";
        document.getElementById("userSection").style.display = "block";
        loadMyMessages();
      }
      loadAllMessages();
    }

    async function loadAllMessages() {
      const res = await fetch("/messages");
      const msgs = await res.json();
      document.getElementById("allMessages").innerHTML =
        msgs.map(m => `<p>${m.text}</p>`).join("");
    }

    async function loadMyMessages() {
      const res = await fetch("/mymessages");
      if (res.status === 401) {
        document.getElementById("myMessages").innerHTML = "<i>Trebuie să fii logat.</i>";
        return;
      }
      const msgs = await res.json();
      document.getElementById("myMessages").innerHTML =
        msgs.map(m => `<p>${m.text}</p>`).join("");
    }

    document.getElementById("newMessageForm").addEventListener("submit", async e => {
      e.preventDefault();
      const text = document.getElementById("messageInput").value;
      const res = await fetch("/messages", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "text=" + encodeURIComponent(text)
      });
      if (res.ok) {
        document.getElementById("messageInput").value = "";
        loadMyMessages();
        loadAllMessages();
      }
    });

    async function logout() {
      await fetch("/auth/logout");
      checkUser();
    }

    checkUser();
  </script>
</body>
</html>
